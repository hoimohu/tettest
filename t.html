<!DOCTYPE html><html lang=ja><meta charset=UTF-8><meta content="width=device-width,initial-scale=1"name=viewport><meta content="noindex , nofollow"name=robots><title>tettest</title><style>#buttonarea{transition:.5s;position:fixed;top:0;left:0}body,html{width:100%;height:100%;margin:0;padding:0;touch-action:none;background-color:#87ceeb}#game{position:fixed;top:0;left:0;display:flex;align-items:center;width:100%;height:100%}#hold,#next{width:80px}#hold,#next,button{color:#fff;-webkit-text-stroke:1px #000;font-size:20px;font-weight:700}#game>div{height:80%;z-index:3}#hold div canvas,#next div canvas{width:80px}#technique{position:fixed;top:15%;left:15%;-webkit-text-stroke:2px #fff;font-size:3em;font-weight:700;z-index:5}#field,#partner{font-size:30px;z-index:2}#next::before{content:'NEXT'}#hold::before{content:'HOLD'}#score::before{content:'スコア: '}#line::before{content:'消した列: '}#chat{position:fixed;bottom:1%;left:.5%;width:100%}#chatinp{width:90%}#chat button{width:8%}#message{transition:.5s;position:fixed;top:10%;left:0;height:80%;opacity:.2;overflow-y:auto;z-index:4;scroll-behavior:smooth}#message::-webkit-scrollbar{opacity:0}#message:hover{opacity:1}#message div{width:max-content;margin:10px;padding:10px;border-radius:6px;background-color:#fff}#backimg{position:fixed;top:10%;left:25%;width:50%;z-index:0}#record div{word-break:break-all}#record div:nth-child(1)::before{content:'40ライン'}#record div:nth-child(2)::before{content:'99ライン'}#record div:nth-child(3)::before{content:'999ライン'}.none{display:none}.flex{display:flex}.red{color:red}.blue{color:#00f}.orange{color:orange}.pixel{image-rendering:pixelated;-ms-interpolation-mode:nearest-neighbor}.trop2{transition:2s;opacity:1}.op0{opacity:0}.op2{opacity:.2}.op6{opacity:.6}.flexbetween{justify-content:space-between}.flexcenter{justify-content:center}</style><img id=backimg src=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAApCAYAAABz26rUAAAAAXNSR0IArs4c6QAAAidJREFUWEftWMltw0AMlOtKFXbyzDcNuAA/XIAbyDdPx6nCdSVggDEohqdWRwTIHwPaXe4Mh8Ndadet/LdbOf5uI7C0gpMqcHg6fN/ut0n3mDT4agjMAdQq1U0ByoylQKsymfWjKICN6D/TlaSxM0AnLSEO/PPrGnJ43r90nESLgs0K0OYSNAG0fpjLSVQIyLlNBDh4Dvr8elbxnz5Ov88liUUIaOAt4JwNJwEVFiVAIDLAJQmuAo2RJ7wmYJ3o6RKSWYICmdKR9SRVwLjXACy10gQkCE6AFACoqP55HA2w1gA0tRAnTcBTAKBBwupAl7fLY+j4fuyZGQNaAiiu1r1ozYNAdJhkCXCQ3oFABDzQWtkRCXmGlBSQQRGQK1AhUDE/VDAJRNcBy2C8C9EmYxKQJekqgBYWdQKtLMZUgIPWPOMqIN0uwVoGo3lVEuQBzfyWgjB9SAAlQZnI1ihvoZky4gZGkqLSG0SAZza6YlrSYx0HDbD0LALO14ce0LpKVgXayDsHNKCzEIhU0EBXslqZW1YgyiqNSwCVrNL67PyyB+TtsZKp7NwsAe4feSvtXSWkB0Ai01m42cYiAODex7F/R8DLttYJVQLSuBUFsmWhtVd6Vv0U+YcABcGdvHq6RmWkHWBVwFKF3m3Ues8dooAmdytYt4QwaH1p8IypZXZIOUSnfYoATcp+YUPAKTKbJZN+ockGnHveRmDujLtdaGkwQ/ZffQn9AMT2MUjamBt7AAAAAElFTkSuQmCC title=tettest><div id=message></div><div id=game><div id=hold><div id=holdmino></div><div id=score></div><div id=line></div><div id=damage></div><div id=record></div></div><div id=field></div><div id=next></div><div id=partner></div></div><div id=buttonarea><div id=button><button onclick=full() type=button>フルスクリーン|フルスクリーン解除</button> <button onclick=start() type=button>スタート</button> <button onclick=battle() type=button>2人で対戦</button></div></div><div id=technique></div><div id=chat class=none><input id=chatinp placeholder=ここに入力して相手に送信...> <button onclick=chatsend() type=button>送信</button></div><script>class field{canvas=document.createElement("canvas");context=this.canvas.getContext("2d");picture=document.createElement("canvas");pctx=this.picture.getContext("2d");netstroke=document.createElement("canvas");nsctx=this.netstroke.getContext("2d");data=[];constructor(t,e,i,n){this.width=t,this.height=e,this.netstroke.width=30,this.netstroke.height=30,this.picture.width=30*this.width,this.picture.height=30*this.height,22<this.height?(this.canvas.width=30*this.width,this.canvas.height=660):(this.canvas.width=30*this.width,this.canvas.height=30*this.height),this.nsctx.lineWidth="2",this.nsctx.strokeStyle="gray",this.nsctx.beginPath(),this.nsctx.moveTo(0,0),this.nsctx.lineTo(0,30),this.nsctx.lineTo(30,30),this.nsctx.lineTo(30,0),this.nsctx.lineTo(0,0),this.nsctx.stroke();for(let i=0;i<e;i++){this.data.push([]);for(let e=0;e<t;e++)this.data.at(-1).push("")}null!=i&&this.setelement(i),null!=n&&(this.gameover=n)}render(){for(let t=0;t<this.data.length;t++)for(let e=0;e<this.data.length;e++){const i=this.data[t][e];this.pctx.globalAlpha=1,""===i?(this.pctx.fillStyle="black",this.pctx.fillRect(30*e,30*t,30,30)):"i"===i?(this.pctx.fillStyle="cyan",this.pctx.fillRect(30*e,30*t,30,30)):"o"===i?(this.pctx.fillStyle="yellow",this.pctx.fillRect(30*e,30*t,30,30)):"t"===i?(this.pctx.fillStyle="purple",this.pctx.fillRect(30*e,30*t,30,30)):"s"===i?(this.pctx.fillStyle="greenyellow",this.pctx.fillRect(30*e,30*t,30,30)):"z"===i?(this.pctx.fillStyle="red",this.pctx.fillRect(30*e,30*t,30,30)):"j"===i?(this.pctx.fillStyle="blue",this.pctx.fillRect(30*e,30*t,30,30)):"l"===i?(this.pctx.fillStyle="orange",this.pctx.fillRect(30*e,30*t,30,30)):"d"===i&&(this.pctx.fillStyle="azure",this.pctx.fillRect(30*e,30*t,30,30)),this.pctx.globalAlpha=.4,this.pctx.drawImage(this.netstroke,30*e,30*t)}return this}netline(){this.pctx.globalAlpha=1,this.pctx.fillStyle="black",this.pctx.fillRect(0,0,this.picture.width,this.picture.height);for(let t=0;t<this.data.length;t++)for(let e=0;e<this.data.length;e++)this.pctx.globalAlpha=.4,this.pctx.drawImage(this.netstroke,30*e,30*t);return this}drawfield(){this.context.drawImage(this.picture,0,this.picture.height-this.canvas.height,this.canvas.width,this.canvas.height,0,0,this.canvas.width,this.canvas.height)}isblock(t,e){return t<0||e<0||this.width<=t||this.height<=e||""!==this.data[e][t]}setelement(t){this.element=t,t.appendChild(this.canvas)}}class mino{landing=!1;fallTimer=0;fallCounter=0;fallCounterCounter=0;angle=0;tspin=!1;miniTspin=!1;constructor(t,e,i,n){this.inter=setInterval((()=>{!1===this.landing?this.fallTimer<=0?(this.minodown(),this.fallTimer=0):this.fallTimer--:clearInterval(this.inter)}),n),this.type=t,this.canvas=e.canvas,this.context=e.context,this.width=e.width,this.height=e.height,this.field=e,null!=i&&(this.landFunction=i),"i"===t?(this.x=5,this.y=2,this.data=[[-3,-1],[-1,-1],[1,-1],[3,-1]]):"t"===t?(this.x=4,this.y=2,this.data=[[-1,0],[0,0],[1,0],[0,-1]]):"l"===t?(this.x=4,this.y=2,this.data=[[1,-1],[-1,0],[0,0],[1,0]]):"j"===t?(this.x=4,this.y=2,this.data=[[-1,-1],[-1,0],[0,0],[1,0]]):"s"===t?(this.x=4,this.y=2,this.data=[[-1,0],[0,0],[0,-1],[1,-1]]):"z"===t?(this.x=4,this.y=2,this.data=[[-1,-1],[0,-1],[0,0],[1,0]]):"o"===t&&(this.x=5,this.y=1,this.data=[[-1,-1],[-1,1],[1,1],[1,-1]]),this.y=this.field.height-22+this.y;let o=!0;for(let e=0;e<this.data.length;e++){const i=this.data[e];"i"===t||"o"===t?this.field.isblock((15*i[0]+30*this.x-15)/30,(15*i[1]+30*this.y-15)/30)&&(o=!1):this.field.isblock(i[0]+this.x,i[1]+this.y)&&(o=!1)}if(!1===o){this.y--,o=!0;for(let e=0;e<this.data.length;e++){const i=this.data[e];"i"===t||"o"===t?this.field.isblock((15*i[0]+30*this.x-15)/30,(15*i[1]+30*this.y-15)/30)&&(o=!1):this.field.isblock(i[0]+this.x,i[1]+this.y)&&(o=!1)}!1===o&&null!=this.field.gameover&&this.field.gameover()}}rotate(t,e=0){if("i"===this.type||"o"===this.type?1===e?0===this.angle?this.x-=1===t?2:1:1===this.angle?1===t?this.x-=1:this.x+=2:2===this.angle?this.x+=1===t?2:1:3===this.angle&&(1===t?this.x+=1:this.x-=2):2===e?0===this.angle?this.x+=3:1===this.angle?1===t?this.x+=3:this.x-=3:2===this.angle?this.x-=3:3===this.angle&&(1===t?this.x-=3:this.x+=3):3===e?0===this.angle?1===t?(this.x-=3,this.y+=1):(this.x-=3,this.y-=2):1===this.angle?1===t?(this.x-=3,this.y-=2):(this.x+=3,this.y-=1):2===this.angle?1===t?(this.x+=3,this.y-=1):(this.x+=3,this.y+=2):3===this.angle&&(1===t?(this.x+=3,this.y+=2):(this.x-=3,this.y+=1)):4===e?0===this.angle?1===t?(this.x+=3,this.y-=3):(this.x+=3,this.y+=3):1===this.angle?1===t?(this.x+=3,this.y+=3):(this.x-=3,this.y+=3):2===this.angle?1===t?(this.x-=3,this.y+=3):(this.x-=3,this.y-=3):3===this.angle&&(1===t?(this.x-=3,this.y-=3):(this.x+=3,this.y+=3)):5===e&&(0===this.angle?1===t?(this.x-=1,this.y+=2):(this.x-=2,this.y-=1):1===this.angle?1===t?(this.x-=2,this.y-=1):(this.x+=1,this.y-=2):2===this.angle?1===t?(this.x+=1,this.y-=2):(this.x+=2,this.y+=1):3===this.angle&&(1===t?(this.x+=2,this.y+=1):(this.x-=1,this.y+=2))):1===e?0===this.angle?1===t?this.x-=1:this.x+=1:1===this.angle?this.x+=1:2===this.angle?1===t?this.x+=1:this.x-=1:3===this.angle&&(this.x-=1):2===e?0===this.angle?this.y-=1:1===this.angle?this.y+=1:2===this.angle?this.y-=1:3===this.angle&&(this.y+=1):3===e?0===this.angle?1===t?(this.x+=1,this.y+=3):(this.x-=1,this.y+=3):1===this.angle?(this.x-=1,this.y-=3):2===this.angle?1===t?(this.x-=1,this.y+=3):(this.x+=1,this.y+=3):3===this.angle&&(this.x+=1,this.y-=3):4===e?0===this.angle?1===t?this.x-=1:this.x+=1:1===this.angle?this.x+=1:2===this.angle?1===t?this.x+=1:this.x-=1:3===this.angle&&(this.x-=1):5===e&&(0===this.angle?1===t?(this.x+=1,this.y-=2):(this.x-=1,this.y-=2):1===this.angle?(this.x-=1,this.y+=2):2===this.angle?1===t?(this.x-=1,this.y-=2):(this.x+=1,this.y-=2):3===this.angle&&(this.x+=1,this.y+=2)),1===t)for(let t=0;t<this.data.length;t++){const e=this.data[t],i=e[0],n=e[1];e[0]=-n,e[1]=i}else if(-1===t)for(let t=0;t<this.data.length;t++){const e=this.data[t],i=e[0],n=e[1];e[0]=n,e[1]=-i}let i=!0;for(let t=0;t<this.data.length;t++){const e=this.data[t];"i"===this.type||"o"===this.type?this.field.isblock((15*e[0]+30*this.x-15)/30,(15*e[1]+30*this.y-15)/30)&&(i=!1):this.field.isblock(e[0]+this.x,e[1]+this.y)&&(i=!1)}if(!1===i){if(-1===t)for(let t=0;t<this.data.length;t++){const e=this.data[t],i=e[0],n=e[1];e[0]=-n,e[1]=i}else if(1===t)for(let t=0;t<this.data.length;t++){const e=this.data[t],i=e[0],n=e[1];e[0]=n,e[1]=-i}5!==e&&this.rotate(t,++e)}else{if(this.angle+=t,this.fallCounter=1,4===this.angle?this.angle=0:-1===this.angle&&(this.angle=3),"t"===this.type){let t=0;this.field.isblock(this.x-1,this.y-1)&&t++,this.field.isblock(this.x+1,this.y-1)&&t++,this.field.isblock(this.x+1,this.y+1)&&t++,this.field.isblock(this.x-1,this.y+1)&&t++,2<t&&(this.tspin=!0),this.tspin&&(0===this.angle?!1!==this.field.isblock(this.x+1,this.y-1)&&!1!==this.field.isblock(this.x-1,this.y-1)||(this.miniTspin=!0):1===this.angle?!1!==this.field.isblock(this.x+1,this.y+1)&&!1!==this.field.isblock(this.x+1,this.y-1)||(this.miniTspin=!0):2===this.angle?!1!==this.field.isblock(this.x+1,this.y+1)&&!1!==this.field.isblock(this.x-1,this.y+1)||(this.miniTspin=!0):3===this.angle&&(!1!==this.field.isblock(this.x-1,this.y+1)&&!1!==this.field.isblock(this.x-1,this.y-1)||(this.miniTspin=!0)))}this.render()}}control(t){if(!1===this.landing){if(" "===t)for(clearInterval(this.inter);!1===this.landing;)this.minodown();else if("ArrowUp"===t)this.rotate(1);else if("z"===t)this.rotate(-1);else if("ArrowRight"===t){let t=!0;for(let e=0;e<this.data.length;e++){const i=this.data[e];"i"===this.type||"o"===this.type?this.field.isblock((15*i[0]+30*this.x-15)/30+1,(15*i[1]+30*this.y-15)/30)&&(t=!1):this.field.isblock(i[0]+this.x+1,i[1]+this.y)&&(t=!1)}!0===t&&(this.fallCounter=1,this.x++,this.tspin=!1,this.miniTspin=!1)}else if("ArrowDown"===t){this.y++;let t=!0;for(let e=0;e<this.data.length;e++){const i=this.data[e];"i"===this.type||"o"===this.type?this.field.isblock((15*i[0]+30*this.x-15)/30,(15*i[1]+30*this.y-15)/30)&&(t=!1):this.field.isblock(i[0]+this.x,i[1]+this.y)&&(t=!1)}!1===t?this.y--:(this.tspin=!1,this.miniTspin=!1)}else if("ArrowLeft"===t){let t=!0;for(let e=0;e<this.data.length;e++){const i=this.data[e];"i"===this.type||"o"===this.type?this.field.isblock((15*i[0]+30*this.x-15)/30-1,(15*i[1]+30*this.y-15)/30)&&(t=!1):this.field.isblock(i[0]+this.x-1,i[1]+this.y)&&(t=!1)}!0===t&&(this.fallCounter=1,this.x--,this.tspin=!1,this.miniTspin=!1)}this.render()}}minodown(){if(!1===this.landing){this.y++;let t=!0;for(let e=0;e<this.data.length;e++){const i=this.data[e];"i"===this.type||"o"===this.type?this.field.isblock((15*i[0]+30*this.x-15)/30,(15*i[1]+30*this.y-15)/30)&&(t=!1):this.field.isblock(i[0]+this.x,i[1]+this.y)&&(t=!1)}if(!1===t)if(this.y--,1!==this.fallCounter||5<this.fallCounterCounter){this.landing=!0;for(let t=0;t<this.data.length;t++){const e=this.data[t];"i"===this.type||"o"===this.type?0<=(15*e[1]+30*this.y-15)/30&&(this.field.data[(15*e[1]+30*this.y-15)/30][(15*e[0]+30*this.x-15)/30]=this.type):0<=e[1]+this.y&&(this.field.data[e[1]+this.y][e[0]+this.x]=this.type)}this.field.render(),null!=this.landFunction&&this.landFunction()}else this.fallCounterCounter++;else this.tspin=!1,this.miniTspin=!1;this.fallCounter=0,this.render()}else this.inter=null}render(){if(!1===this.landing){let t=this.y,e=!0;for(;e;){let i=!0;for(let e=0;e<this.data.length;e++){const n=this.data[e];"i"===this.type||"o"===this.type?this.field.isblock((15*n[0]+30*this.x-15)/30,(15*n[1]+30*t-15)/30)&&(i=!1):this.field.isblock(n[0]+this.x,n[1]+t)&&(i=!1)}!0===i?t++:(t--,e=!1)}this.field.drawfield();for(let t=0;t<this.data.length;t++){const e=this.data[t];this.context.globalAlpha=1,"i"===this.type?(this.context.fillStyle="cyan",this.context.fillRect(15*e[0]+30*this.x-15,15*e[1]+30*(this.y+22-this.field.height)-15,30,30)):"o"===this.type?(this.context.fillStyle="yellow",this.context.fillRect(15*e[0]+30*this.x-15,15*e[1]+30*(this.y+22-this.field.height)-15,30,30)):"t"===this.type?(this.context.fillStyle="purple",this.context.fillRect(30*(e[0]+this.x),30*(e[1]+this.y+22-this.field.height),30,30)):"s"===this.type?(this.context.fillStyle="greenyellow",this.context.fillRect(30*(e[0]+this.x),30*(e[1]+this.y+22-this.field.height),30,30)):"z"===this.type?(this.context.fillStyle="red",this.context.fillRect(30*(e[0]+this.x),30*(e[1]+this.y+22-this.field.height),30,30)):"j"===this.type?(this.context.fillStyle="blue",this.context.fillRect(30*(e[0]+this.x),30*(e[1]+this.y+22-this.field.height),30,30)):"l"===this.type&&(this.context.fillStyle="orange",this.context.fillRect(30*(e[0]+this.x),30*(e[1]+this.y+22-this.field.height),30,30)),this.context.globalAlpha=.4,"i"===this.type||"o"===this.type?this.context.drawImage(this.field.netstroke,15*e[0]+30*this.x-15,15*e[1]+30*(this.y+22-this.field.height)-15):this.context.drawImage(this.field.netstroke,30*(e[0]+this.x),30*(e[1]+this.y+22-this.field.height))}this.context.globalAlpha=.6;for(let e=0;e<this.data.length;e++){const i=this.data[e];"i"===this.type?(this.context.fillStyle="cyan",this.context.fillRect(15*i[0]+30*this.x-15,15*i[1]+30*(t+22-this.field.height)-15,30,30)):"o"===this.type?(this.context.fillStyle="yellow",this.context.fillRect(15*i[0]+30*this.x-15,15*i[1]+30*(t+22-this.field.height)-15,30,30)):"t"===this.type?(this.context.fillStyle="purple",this.context.fillRect(30*(i[0]+this.x),30*(i[1]+t+22-this.field.height),30,30)):"s"===this.type?(this.context.fillStyle="greenyellow",this.context.fillRect(30*(i[0]+this.x),30*(i[1]+t+22-this.field.height),30,30)):"z"===this.type?(this.context.fillStyle="red",this.context.fillRect(30*(i[0]+this.x),30*(i[1]+t+22-this.field.height),30,30)):"j"===this.type?(this.context.fillStyle="blue",this.context.fillRect(30*(i[0]+this.x),30*(i[1]+t+22-this.field.height),30,30)):"l"===this.type&&(this.context.fillStyle="orange",this.context.fillRect(30*(i[0]+this.x),30*(i[1]+t+22-this.field.height),30,30))}}}}const fieldElement=document.getElementById("field"),btn=document.getElementById("button"),tech=document.getElementById("technique"),next=document.getElementById("next"),scoreElement=document.getElementById("score"),partner=document.getElementById("partner"),damageElement=document.getElementById("damage"),chatElement=document.getElementById("chat"),chatinp=document.getElementById("chatinp"),messageElement=document.getElementById("message"),holdElement=document.getElementById("holdmino"),backimgElement=document.getElementById("backimg"),gameElement=document.getElementById("game"),btnareaElement=document.getElementById("buttonarea"),lineElement=document.getElementById("line"),recordElement=document.getElementById("record");let gamemode,sock,starttime,game=!0,fullscreen=!1,runstopbool=!0,nextNum=5;const mino7=["i","t","o","s","z","l","j"],nextElement=[],nextMino=[];let main,dMain,pMain,nowMino,battleFunction,endBattleFunction,attackBattleFunction,sendChatFunction,ren=-1,linebreak=0,btb=!1,score=0,holdMino="none",permHold=!0,lasthole=null,gameset=!1,HNalpha=!1,RQA=!1,mydamage=[];function msgDisplay(t,e){const i=document.createElement("div");i.innerText=t,i.style="color:"+e+";",i.classList.add("trop2"),tech.appendChild(i),setTimeout((()=>{i.classList.add("op0"),setTimeout((()=>{i.remove()}),2e3)}),100)}function send(t){null!=sock&&sock.send(JSON.stringify(t))}function chatsend(){null==sendChatFunction||chatinp.value.match(/^[\s　ᅟᅠ᠎​‌⁣‍⁠⁡⁢⁣⁤ㅤﾠ]*$/)||(sendChatFunction(chatinp.value),chatinp.value="")}function techsend(t){null!=sendChatFunction&&sendChatFunction(t,!0)}function time(t){return Math.floor(t/36e5)+":"+Math.floor(t/6e4)%60+":"+Math.floor(t/1e3)%60+":"+t%1e3}chatinp.addEventListener("keydown",(t=>{"Enter"===t.key&&chatsend()}));for(let t=0;t<nextNum;t++){const t=document.createElement("div");next.appendChild(t),nextElement.push(t)}const previewMino={i:new field(4,4),t:new field(3,3),s:new field(3,3),z:new field(3,3),j:new field(3,3),l:new field(3,3),o:new field(4,4),none:new field(4,4)};previewMino.i.data[1][0]="i",previewMino.i.data[1][1]="i",previewMino.i.data[1][2]="i",previewMino.i.data[1][3]="i",previewMino.i.netline().render().drawfield(),previewMino.t.data[1][0]="t",previewMino.t.data[1][1]="t",previewMino.t.data[1][2]="t",previewMino.t.data[0][1]="t",previewMino.t.netline().render().drawfield(),previewMino.s.data[0][1]="s",previewMino.s.data[0][2]="s",previewMino.s.data[1][0]="s",previewMino.s.data[1][1]="s",previewMino.s.netline().render().drawfield(),previewMino.z.data[0][0]="z",previewMino.z.data[0][1]="z",previewMino.z.data[1][1]="z",previewMino.z.data[1][2]="z",previewMino.z.netline().render().drawfield(),previewMino.j.data[0][0]="j",previewMino.j.data[1][0]="j",previewMino.j.data[1][1]="j",previewMino.j.data[1][2]="j",previewMino.j.netline().render().drawfield(),previewMino.l.data[0][2]="l",previewMino.l.data[1][0]="l",previewMino.l.data[1][1]="l",previewMino.l.data[1][2]="l",previewMino.l.netline().render().drawfield(),previewMino.o.data[0][1]="o",previewMino.o.data[1][1]="o",previewMino.o.data[0][2]="o",previewMino.o.data[1][2]="o",previewMino.o.netline().render().drawfield(),previewMino.none.netline().render().drawfield();let rightLoopPerm=!1,rightLoopNow=!1,rightLoopCount=0,rightLoop60=setInterval((()=>{RQA?clearInterval(rightLoop60):game&&(!0===rightLoopPerm&&!1===leftLoopNow?(rightLoopNow=!0,rightLoopCount++):(rightLoopNow=!1,rightLoopCount=0),(1===rightLoopCount||15<rightLoopCount)&&rightLoopCount%2==1&&null!=nowMino&&nowMino.control("ArrowRight"))}),1e3/90);function rightLoop(){RQA&&(game&&(!0===rightLoopPerm&&!1===leftLoopNow?(rightLoopNow=!0,rightLoopCount++):(rightLoopNow=!1,rightLoopCount=0),(1===rightLoopCount||15<rightLoopCount)&&rightLoopCount%2==1&&null!=nowMino&&nowMino.control("ArrowRight")),requestAnimationFrame(rightLoop))}let leftLoopPerm=!1,leftLoopNow=!1,leftLoopCount=0,leftLoop60=setInterval((()=>{RQA?clearInterval(leftLoop60):game&&(!0===leftLoopPerm&&!1===rightLoopNow?(leftLoopNow=!0,leftLoopCount++):(leftLoopNow=!1,leftLoopCount=0),(1===leftLoopCount||15<leftLoopCount)&&leftLoopCount%2==1&&null!=nowMino&&nowMino.control("ArrowLeft"))}),1e3/90);function leftLoop(){RQA&&(game&&(!0===leftLoopPerm&&!1===rightLoopNow?(leftLoopNow=!0,leftLoopCount++):(leftLoopNow=!1,leftLoopCount=0),(1===leftLoopCount||15<leftLoopCount)&&leftLoopCount%2==1&&null!=nowMino&&nowMino.control("ArrowLeft")),requestAnimationFrame(leftLoop))}let downLoopPerm=!1,downLoopCount=0,downLoop60=setInterval((()=>{RQA?clearInterval(downLoop60):game&&(!0===downLoopPerm?downLoopCount++:downLoopCount=0,downLoopCount%2==1&&null!=nowMino&&nowMino.control("ArrowDown"))}),1e3/90);function downLoop(){RQA&&(game&&(!0===downLoopPerm?downLoopCount++:downLoopCount=0,downLoopCount%2==1&&null!=nowMino&&nowMino.control("ArrowDown")),requestAnimationFrame(downLoop))}function RQAor60FPS(){RQAor90btnE.blur(),RQA?(RQA=!1,rightLoop60=setInterval((()=>{RQA?clearInterval(rightLoop60):game&&(!0===rightLoopPerm&&!1===leftLoopNow?(rightLoopNow=!0,rightLoopCount++):(rightLoopNow=!1,rightLoopCount=0),(1===rightLoopCount||15<rightLoopCount)&&rightLoopCount%2==1&&null!=nowMino&&nowMino.control("ArrowRight"))}),1e3/90),leftLoop60=setInterval((()=>{RQA?clearInterval(leftLoop60):game&&(!0===leftLoopPerm&&!1===rightLoopNow?(leftLoopNow=!0,leftLoopCount++):(leftLoopNow=!1,leftLoopCount=0),(1===leftLoopCount||15<leftLoopCount)&&leftLoopCount%2==1&&null!=nowMino&&nowMino.control("ArrowLeft"))}),1e3/90),downLoop60=setInterval((()=>{RQA?clearInterval(downLoop60):game&&(!0===downLoopPerm?downLoopCount++:downLoopCount=0,downLoopCount%2==1&&null!=nowMino&&nowMino.control("ArrowDown"))}),1e3/90),RQAor90btnE.innerText="90fps固定中"):(RQA=!0,rightLoop(),leftLoop(),downLoop(),RQAor90btnE.innerText="自動調整中")}const RQAor90btnE=document.createElement("button");function minobag(t=!1){if(game&&runstopbool){let i=0,n=0,o=!0,l=0;for(let t=0;t<main.data.length;t++){if(-1===main.data[t].indexOf("")){main.data.splice(t,1);const e=[];for(let t=0;t<main.width;t++)e.push("");if(main.data.unshift(e),n++,linebreak++,40===linebreak){const t=document.createElement("div");t.className="red",t.innerText="\n"+time(Date.now()-starttime),recordElement.appendChild(t)}else if(99===linebreak){const t=document.createElement("div");t.className="blue",t.innerText="\n"+time(Date.now()-starttime),recordElement.appendChild(t)}else if(999===linebreak){t.className="orange";const t=document.createElement("div");t.innerText="\n"+time(Date.now()-starttime),recordElement.appendChild(t)}}""!==main.data[t].join("")&&(o=!1)}function e(){if(game){if(runstopbool=!0,nextMino.length<=nextNum)for(;nextMino.length<=nextNum;){const t=JSON.parse(JSON.stringify(mino7));for(;0!==t.length;)nextMino.push(t.splice(Math.floor(Math.random()*t.length),1)[0])}let e=1250;for(let t=0;t<linebreak/40;t++)e-=50;nowMino=new mino(nextMino.shift(),main,minobag,e);for(let t=0;t<5;t++){const e=previewMino[nextMino[t]].canvas.cloneNode();e.getContext("2d").drawImage(previewMino[nextMino[t]].canvas,0,0),nextElement[t].innerHTML="",nextElement[t].appendChild(e)}if(null!=holdMino){const t=previewMino[holdMino].canvas.cloneNode();t.getContext("2d").drawImage(previewMino[holdMino].canvas,0,0),holdElement.innerHTML="",holdElement.appendChild(t)}score+=100*i+100*l,scoreElement.innerText=score,nowMino.render(),"battle"===gamemode&&!1===t&&(attackBattleFunction(i),battleFunction()),permHold=!t}else nowMino.landing=!0}0!==n&&(lineElement.innerText=linebreak,main.render().drawfield()),null!=nowMino&&nowMino.tspin&&(0===n?nowMino.miniTspin?(msgDisplay("T-Spin Mini","#00f"),techsend("T-Spin Mini")):(msgDisplay("T-Spin","#00f"),techsend("T-Spin")):1===n?nowMino.miniTspin?(msgDisplay("T-Spin Mini Single","#00f"),techsend("T-Spin Mini Single")):(msgDisplay("T-Spin Single","#00f"),techsend("T-Spin Single"),i+=2):2===n?nowMino.miniTspin?(msgDisplay("T-Spin Mini Double","#00f"),techsend("T-Spin Mini Double")):(msgDisplay("T-Spin Double","#00f"),techsend("T-Spin Double"),i+=4):3===n&&(msgDisplay("T-Spin Triple","#00f"),techsend("T-Spin Triple"),i+=6),btb&&!0===nowMino.tspin&&0<n?(msgDisplay("Back-to-Back","#00f",1),techsend("Back-to-Back"),i+=1):!0===nowMino.tspin&&0<n&&(btb=!0)),4===n?(msgDisplay("Tetris","#00f"),techsend("Tetris"),i+=4,btb?(msgDisplay("Back-to-Back","#00f",1),techsend("Back-to-Back"),i+=1):btb=!0):0<n&&(!1===nowMino.tspin||!0===nowMino.miniTspin)&&(btb=!1,i+=n-1,l++),o&&0<n?(ren++,msgDisplay("Perfect Clear","greenyellow",-2),techsend("Perfect Clear"),i+=10):0<n?(ren++,0<ren&&(msgDisplay(ren+"REN","#00f",-1),techsend(ren+"REN")),10<ren?i+=5:7<ren?i+=4:5<ren?i+=3:3<ren?i+=2:1<ren&&(i+=1)):!1===t&&(ren=-1),0<n?(runstopbool=!1,setTimeout(e,300)):e()}else"normal"===gamemode?(nowMino.landing=!0,startMenu(),msgDisplay("GAME OVER","red")):"battle"===gamemode&&(endBattleFunction(),nowMino.landing=!0)}function start(){for(starttime=Date.now(),rightLoopPerm=!1,rightLoopCount=0,leftLoopPerm=!1,leftLoopCount=0,downLoopPerm=!1,downLoopCount=0,linebreak=0,lineElement.innerText="0",recordElement.innerHTML="",backimgElement.className="",btn.innerHTML='<button onclick="full()">フルスクリーン|フルスクリーン解除</button><button onclick="start()">最初から</button><button onclick="startMenu()" type="button">メニューに戻る</button>',gameElement.className="flexcenter",gamemode="normal",null!=nowMino&&(main.canvas.remove(),nowMino.landing=!0);0!==nextElement.length;)nextElement.shift().remove();for(;0!==nextMino.length;)nextMino.shift();for(let t=-1;t<nextNum;t++){const t=document.createElement("div");next.appendChild(t),nextElement.push(t)}game=!0,runstopbool=!0,btb=!1,score=0,ren=-1,holdMino="none",permHold=!0,main=new field(10,50,fieldElement,(()=>{game=!1,gameset=!0})),main.netline().drawfield(),minobag()}function battle(){if("battle"!==gamemode){for(starttime=Date.now(),gamemode="battle",rightLoopPerm=!1,rightLoopCount=0,leftLoopPerm=!1,leftLoopCount=0,downLoopPerm=!1,downLoopCount=0,linebreak=0,messageElement.innerHTML="",tech.innerHTML="",next.innerHTML="",scoreElement.innerHTML="",damageElement.innerHTML="",holdElement.innerHTML="",fieldElement.innerHTML="",partner.innerHTML="",lineElement.innerText="0",recordElement.innerHTML="",btn.innerHTML='<button type="button" onclick="full()">フルスクリーン|フルスクリーン解除</button>',gameElement.className="flexbetween",chatinp.value="";0!==nextElement.length;)nextElement.shift();for(let t=-1;t<nextNum;t++){const t=document.createElement("div");next.appendChild(t),nextElement.push(t)}if(null!=nowMino)for(main.canvas.remove(),nowMino.landing=!0;0!==nextMino.length;)nextMino.shift();if(game=!0,runstopbool=!0,btb=!1,score=0,ren=-1,holdMino="none",permHold=!0,mydamage=[],main=new field(10,50,fieldElement,(()=>{game=!1,gameset=!0})),null!=holdMino){const t=previewMino[holdMino].canvas.cloneNode();t.getContext("2d").drawImage(previewMino[holdMino].canvas,0,0),holdElement.innerHTML="",holdElement.appendChild(t)}main.netline().drawfield(),pMain=new field(10,50,partner),pMain.netline().drawfield(),dMain=new field(1,1,damageElement),dMain.netline().drawfield(),backimgElement.className="",null==sock&&(msgDisplay("サーバーに接続します","blue"),sock=new WebSocket("wss://horse-tortoiseshell-crater.glitch.me"),sock.addEventListener("open",(()=>{chatElement.className="flex",battleFunction=()=>{send({type:"battle",battle:"field",data:main.data})},endBattleFunction=()=>{gameset&&"battle"===gamemode&&send({type:"battle",battle:"lose",score:score})},attackBattleFunction=t=>{if(t<=mydamage.length){for(let t=0;!(0===mydamage.length||11<t);t++)main.data.shift(),main.data.push(mydamage.shift());1===mydamage.length?dMain.data[0][0]="i":2===mydamage.length?dMain.data[0][0]="j":3===mydamage.length?dMain.data[0][0]="l":4===mydamage.length?dMain.data[0][0]="o":5===mydamage.length?dMain.data[0][0]="s":6===mydamage.length?dMain.data[0][0]="t":7<mydamage.length?dMain.data[0][0]="z":dMain.data[0][0]="",dMain.render().drawfield(),main.render().drawfield()}else send({type:"battle",battle:"attack",data:t-mydamage})},sendChatFunction=(t,e)=>{send(!0===e?{type:"tech",data:t}:{type:"chat",data:t})}})),sock.addEventListener("message",(t=>{const e=JSON.parse(t.data);if("key"===e.type)send({type:"keyconnect",data:e.data});else if("count"===e.type){if(3===e.count){if(nextMino.length<=nextNum)for(;nextMino.length<=nextNum;){const t=JSON.parse(JSON.stringify(mino7));for(;0!==t.length;)nextMino.push(t.splice(Math.floor(Math.random()*t.length),1)[0])}for(let t=0;t<5;t++){const e=previewMino[nextMino[t]].canvas.cloneNode();e.getContext("2d").drawImage(previewMino[nextMino[t]].canvas,0,0),nextElement[t].innerHTML="",nextElement[t].appendChild(e)}}msgDisplay(""+e.count,"blue")}else if("start"===e.type)msgDisplay("START!","greenyellow"),main.netline().drawfield(),minobag();else if("attack"===e.type){const t=[];if(null!=lasthole&&.25<Math.random()){const e=lasthole;for(let i=0;i<main.width;i++)i===e?t.push(""):t.push("d")}else{const e=Math.floor(Math.random()*main.width);lasthole=e;for(let i=0;i<main.width;i++)i===e?t.push(""):t.push("d")}for(let i=0;i<e.data;i++)mydamage.push(JSON.parse(JSON.stringify(t)));0===mydamage.length?dMain.data[0][0]="i":1===mydamage.length?dMain.data[0][0]="j":2===mydamage.length?dMain.data[0][0]="l":3===mydamage.length?dMain.data[0][0]="o":4===mydamage.length?dMain.data[0][0]="s":5===mydamage.length?dMain.data[0][0]="t":5<mydamage.length&&(dMain.data[0][0]="z"),dMain.render().drawfield()}else if("field"===e.type)pMain.data=e.data,pMain.render().drawfield();else if("lose"===e.type){gamemode="fin",game=!1,nowMino.landing=!0;const t=document.createElement("div");t.classList.add("blue"),t.innerText="あなたのまけです。。。。\n・・・スコア: "+score+"\n\n相手のスコア: "+e.score,messageElement.appendChild(t),t.scrollIntoView(!1),msgDisplay("You lose...","blue"),setTimeout((()=>{msgDisplay("You lose...","blue"),btn.innerHTML='<button type="button" onclick="conti()">つづけて誰かと対戦する</button><button type="button" onclick="full()">フルスクリーン|フルスクリーン解除</button><button onclick="startMenu()" type="button">メニューに戻る</button>'}),1e3),continueperm=!0}else if("win"===e.type){gamemode="fin",game=!1,nowMino.landing=!0;const t=document.createElement("div");t.classList.add("orange"),t.innerText="かち！！！！\n・・・スコア: "+score+"\n\n相手のスコア: "+e.score,messageElement.appendChild(t),t.scrollIntoView(!1),send({type:"battle",battle:"win",score:score}),msgDisplay("YOU WIN!!","greenyellow"),setTimeout((()=>{setTimeout((()=>{msgDisplay("You WIN!!","greenyellow"),btn.innerHTML='<button type="button" onclick="conti()">つづけて誰かと対戦する</button><button type="button" onclick="full()">フルスクリーン|フルスクリーン解除</button><button onclick="startMenu()" type="button">メニューに戻る</button>'}),1e3),continueperm=!0}),1e3)}else if("chat"===e.type){"わざ・お相手"===e.owner&&msgDisplay(e.data,"red",2);const t=document.createElement("div");t.innerText=e.owner+": "+e.data,messageElement.appendChild(t),t.scrollIntoView(!1)}else if("disconnect"===e.type){msgDisplay("相手の接続が切断されました","red");const t=document.createElement("div");t.classList.add("red"),t.innerText="相手の接続が切断されました",messageElement.appendChild(t),t.scrollIntoView(!1),send({type:"partnernull"})}else"continue"===e.type&&(nowMino.landing=!0,battle())})),sock.addEventListener("close",(()=>{msgDisplay("サーバーとの接続が切断されました","red");const t=document.createElement("div");t.classList.add("red"),t.innerText="サーバーとの接続が切断されました",messageElement.appendChild(t),t.scrollIntoView(!1)})),sock.addEventListener("error",(()=>{msgDisplay("エラーが発生しました","red");const t=document.createElement("div");t.classList.add("red"),t.innerText="エラーが発生しました",messageElement.appendChild(t),t.scrollIntoView(!1)})))}}function startMenu(){if("startmenu"!==gamemode){if(rightLoopPerm=!1,rightLoopCount=0,leftLoopPerm=!1,leftLoopCount=0,downLoopPerm=!1,downLoopCount=0,linebreak=0,null!=nowMino)for(main.canvas.remove(),nowMino.landing=!0;0!==nextMino.length;)nextMino.shift();game=!1,nowMino=null,main=null}btn.innerHTML='<button onclick="full()" type="button">フルスクリーン|フルスクリーン解除</button><button onclick="start()" type="button">スタート</button><button onclick="battle()" type="button">2人で対戦</button>',gameElement.className="flexcenter",tech.innerHTML="",next.innerHTML="",scoreElement.innerHTML="",partner.innerHTML="",damageElement.innerHTML="",messageElement.innerHTML="",holdElement.innerHTML="",lineElement.innerText="",recordElement.innerHTML="",messageElement.innerHTML="",chatElement.className="none",gamemode="startmenu",backimgElement.className="pixel"}RQAor90btnE.setAttribute("type","button"),RQAor90btnE.innerText="90fps固定中",RQAor90btnE.addEventListener("click",RQAor60FPS),btnareaElement.appendChild(RQAor90btnE),document.addEventListener("keydown",(t=>{game&&null!=nowMino?(!0!==t.ctrlKey&&document.activeElement!==chatinp&&t.preventDefault(),!1===t.repeat&&(" "===t.key&&(score+=5),"ArrowRight"===t.key?rightLoopPerm=!0:"ArrowLeft"===t.key?leftLoopPerm=!0:"ArrowDown"===t.key?downLoopPerm=!0:"c"===t.key?permHold&&runstopbool&&("none"===holdMino?(nowMino.landing=!0,holdMino=nowMino.type,minobag(!0)):(nowMino.landing=!0,nextMino.unshift(holdMino),holdMino=nowMino.type,minobag(!0))):"a"===t.key?!1===HNalpha?(btnareaElement.className="op2",HNalpha=!0):(btnareaElement.className="",HNalpha=!1):"r"===t.key&&"normal"===gamemode?start():"Escape"===t.key&&"normal"===gamemode?startMenu():runstopbool&&nowMino.control(t.key))):!1===game&&null!=nowMino&&"Escape"===t.key&&"fin"===gamemode?startMenu():!1===game&&null!=nowMino&&"r"===t.key&&"fin"===gamemode&&null!=sock&&conti()})),document.addEventListener("keyup",(t=>{game&&("ArrowRight"===t.key?(rightLoopPerm=!1,rightLoopCount=0):"ArrowLeft"===t.key?(leftLoopPerm=!1,leftLoopCount=0):"ArrowDown"===t.key&&(downLoopPerm=!1,downLoopCount=0))}));let continueperm=!1;function conti(){continueperm&&(continueperm=!1,send({type:"continue"}))}function full(){btn.innerHTML=btn.innerHTML,!1===fullscreen?(document.body.requestFullscreen(),fullscreen=!0):(document.exitFullscreen(),fullscreen=!1)}window.onload=startMenu;</script>